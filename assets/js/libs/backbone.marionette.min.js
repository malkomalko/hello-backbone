// Backbone.Marionette v0.5.2
//
// Copyright (C)2011 Derick Bailey, Muted Solutions, LLC
// Distributed Under MIT License
//
// Documentation and Full License Available at:
// http://github.com/derickbailey/backbone.marionette
Backbone.Marionette=function(e,c,f){var b={version:"0.5.2"};b.ItemView=e.View.extend({constructor:function(){var a=k.call(arguments);e.View.prototype.constructor.apply(this,a);c.bindAll(this,"render");this.initialEvents()},initialEvents:function(){this.collection&&this.bindTo(this.collection,"reset",this.render,this)},serializeData:function(){var a;this.collection&&(a={},a.items=this.collection.toJSON());this.model&&(a=this.model.toJSON());return a},template:function(){return f(this.options.template)},
render:function(){var a=this,d=this.serializeData();this.getTemplate(function(b){b=a.renderTemplate(b,d);a.$el.html(b);if(a.onRender)a.onRender()});return this},renderTemplate:function(a,d){if(!a||0===a.length){var b=Error("A template must be specified");b.name="NoTemplateError";throw b;}return c.template(a.html(),d)},getTemplate:function(a){var d=this.template;c.isFunction(d)?(d=d.call(this),a.call(this,d)):b.TemplateManager.get(d,a)},close:function(){this.unbindAll();this.unbind();this.remove();
if(this.onClose)this.onClose()}});b.CollectionView=e.View.extend({constructor:function(){e.View.prototype.constructor.apply(this,arguments);c.bindAll(this,"addChildView","render");this.initialEvents()},initialEvents:function(){this.bindTo(this.collection,"add",this.addChildView,this);this.bindTo(this.collection,"remove",this.removeChildView,this);this.bindTo(this.collection,"reset",this.reRender,this)},reRender:function(){this.closeChildren();this.render()},render:function(){this.collection.each(this.addChildView);
if(this.onRender)this.onRender();return this},addChildView:function(a){this.appendHtml(this.$el,this.renderItem(a))},removeChildView:function(a){var d=this.children[a.cid];d&&(d.close(),delete this.children[a.cid])},appendHtml:function(a,d){a.append(d)},renderItem:function(a){if(!this.itemView)throw a=Error("An `itemView` must be specified"),a.name="NoItemViewError",a;a=new this.itemView({model:a});a.render();this.storeChild(a);return a.el},storeChild:function(a){this.children||(this.children={});
this.children[a.model.cid]=a},close:function(){this.unbind();this.unbindAll();this.remove();this.closeChildren();if(this.onClose)this.onClose()},closeChildren:function(){this.children&&c.each(this.children,function(a){a.close()})}});b.CompositeView=b.CollectionView.extend({modelView:b.ItemView,render:function(){this.renderModel();b.CollectionView.prototype.render.call(this,arguments)},renderModel:function(){if(!this.modelViewRendered&&(this.modelViewRendered=!0,this.template)){var a=new this.modelView({model:this.model,
template:this.template});a.render();this.$el.append(a.el)}}});b.RegionManager=function(a){this.options=a||{};this.options.el&&(this.el=a.el);if(!this.el)throw a=Error("An 'el' must be specified"),a.name="NoElError",a;};c.extend(b.RegionManager.prototype,e.Events,{show:function(a,d){this.ensureEl();this.close();this.open(a,d);this.currentView=a},ensureEl:function(){if(!this.$el||0==this.$el.length)this.$el=f(this.el)},open:function(a,d){var b=this,d=d||"html";f.when(a.render()).then(function(){b.$el[d](a.el);
a.onShow&&a.onShow();b.trigger("view:show",a)})},close:function(){var a=this.currentView;a&&(a.close&&a.close(),this.trigger("view:closed",a),delete this.currentView)},attachView:function(a){this.currentView=a}});b.LayoutManager=b.ItemView.extend({constructor:function(){e.Marionette.ItemView.apply(this,arguments);this.regionManagers={};this.vent=new e.Marionette.EventAggregator},render:function(){e.Marionette.ItemView.prototype.render.call(this,arguments);this.initializeRegions()},close:function(){e.Marionette.ItemView.prototype.close.call(this,
arguments);this.closeRegions()},initializeRegions:function(){var a=this;c.each(this.regions,function(d,b){var c=new e.Marionette.RegionManager({el:d});a.regionManagers[b]=c;a[b]=c})},closeRegions:function(){var a=this;c.each(this.regionManagers,function(d,b){d.close();delete a[b]});delete this.regionManagers}});b.CompositeRegion=b.LayoutManager;b.AppRouter=e.Router.extend({constructor:function(a){e.Router.prototype.constructor.call(this,a);if(this.appRoutes){var d=this.controller;a&&a.controller&&
(d=a.controller);this.processAppRoutes(d,this.appRoutes)}},processAppRoutes:function(a,d){var b,e,g,f,h=[];for(g in d)h.unshift([g,d[g]]);f=h.length;for(var i=0;i<f;i++)g=h[i][0],e=h[i][1],b=c.bind(a[e],a),this.route(g,e,b)}});b.BindTo={bindTo:function(a,d,b,c){c=c||this;a.on(d,b,c);this.bindings||(this.bindings=[]);this.bindings.push({obj:a,eventName:d,callback:b,context:c})},unbindAll:function(){c.each(this.bindings,function(a){a.obj.off(a.eventName,a.callback)});this.bindings=[]}};b.Callbacks=
function(){this.deferred=f.Deferred();this.promise=this.deferred.promise()};c.extend(b.Callbacks.prototype,{add:function(a){this.promise.done(function(b,c){a.call(b,c)})},run:function(a,b){this.deferred.resolve(a,b)}});b.EventAggregator=function(a){c.extend(this,a)};c.extend(b.EventAggregator.prototype,e.Events,b.BindTo,{bindTo:function(a,d,c){b.BindTo.bindTo.call(this,this,a,d,c)}});b.Application=function(a){this.initCallbacks=new b.Callbacks;this.vent=new b.EventAggregator;c.extend(this,a)};c.extend(b.Application.prototype,
e.Events,{addInitializer:function(a){this.initCallbacks.add(a)},start:function(a){this.trigger("initialize:before",a);this.initCallbacks.run(this,a);this.trigger("initialize:after",a);this.trigger("start",a)},addRegions:function(a){var d,c;for(c in a)a.hasOwnProperty(c)&&(d=a[c],d="string"===typeof d?new b.RegionManager({el:d}):new d,this[c]=d)}});b.TemplateManager={templates:{},get:function(a,b){var c=this.templates[a];if(c)b&&b.call(this,c);else{var e=this;this.loadTemplate(a,function(c){e.templates[a]=
c;b&&b.call(e,c)})}},loadTemplate:function(a,b){b.call(this,f(a))},clear:function(){var a=arguments.length;if(0<a)for(var b=0;b<a;b++)delete this.templates[arguments[b]];else this.templates={}}};var k=Array.prototype.slice,j=e.View.extend;b.RegionManager.extend=j;b.Application.extend=j;c.extend(b.ItemView.prototype,b.BindTo);c.extend(b.CollectionView.prototype,b.BindTo);c.extend(b.Application.prototype,b.BindTo);c.extend(b.RegionManager.prototype,b.BindTo);return b}(Backbone,_,window.jQuery||window.Zepto||
window.ender);
